{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/maron/Documents/forecast-agent-api/web/lib/prompt.ts"],"sourcesContent":["type Deal = Record<string, any>;\ntype ScoreDef = { category: string; score: number; label?: string; criteria?: string };\n\nfunction formatScoreDefinitions(defs: ScoreDef[]) {\n  if (!Array.isArray(defs) || defs.length === 0) return \"No criteria available.\";\n  const byCat = new Map<string, ScoreDef[]>();\n  for (const row of defs) {\n    const cat = row.category || \"unknown\";\n    if (!byCat.has(cat)) byCat.set(cat, []);\n    byCat.get(cat)!.push(row);\n  }\n  const lines: string[] = [];\n  for (const [cat, rows] of byCat.entries()) {\n    rows.sort((a, b) => Number(a.score) - Number(b.score));\n    lines.push(`${cat.toUpperCase()}:`);\n    for (const r of rows) {\n      lines.push(`- ${r.score}: ${r.label || \"\"} — ${r.criteria || \"\"}`);\n    }\n  }\n  return lines.join(\"\\n\");\n}\n\nfunction buildLabelMap(defs: ScoreDef[]) {\n  const map: Record<string, Record<number, string>> = {};\n  for (const row of defs || []) {\n    const cat = row.category;\n    if (!cat) continue;\n    if (!map[cat]) map[cat] = {};\n    map[cat][Number(row.score)] = row.label || \"\";\n  }\n  return map;\n}\n\nfunction computeFirstGap(deal: Deal, stage: string, touchedSet?: Set<string>) {\n  const stageStr = String(stage || deal?.forecast_stage || \"Pipeline\");\n  const pipelineOrder = [\n    { name: \"Pain\", key: \"pain_score\", val: deal.pain_score, touchedKey: \"pain\" },\n    { name: \"Metrics\", key: \"metrics_score\", val: deal.metrics_score, touchedKey: \"metrics\" },\n    { name: \"Internal Sponsor\", key: \"champion_score\", val: deal.champion_score, touchedKey: \"champion\" },\n    { name: \"Competition\", key: \"competition_score\", val: deal.competition_score, touchedKey: \"competition\" },\n    { name: \"Budget\", key: \"budget_score\", val: deal.budget_score, touchedKey: \"budget\" },\n  ];\n  const bestCaseCommitOrder = [\n    { name: \"Pain\", key: \"pain_score\", val: deal.pain_score, touchedKey: \"pain\" },\n    { name: \"Metrics\", key: \"metrics_score\", val: deal.metrics_score, touchedKey: \"metrics\" },\n    { name: \"Internal Sponsor\", key: \"champion_score\", val: deal.champion_score, touchedKey: \"champion\" },\n    { name: \"Criteria\", key: \"criteria_score\", val: deal.criteria_score, touchedKey: \"criteria\" },\n    { name: \"Competition\", key: \"competition_score\", val: deal.competition_score, touchedKey: \"competition\" },\n    { name: \"Timing\", key: \"timing_score\", val: deal.timing_score, touchedKey: \"timing\" },\n    { name: \"Budget\", key: \"budget_score\", val: deal.budget_score, touchedKey: \"budget\" },\n    { name: \"Economic Buyer\", key: \"eb_score\", val: deal.eb_score, touchedKey: \"eb\" },\n    { name: \"Decision Process\", key: \"process_score\", val: deal.process_score, touchedKey: \"process\" },\n    { name: \"Paper Process\", key: \"paper_score\", val: deal.paper_score, touchedKey: \"paper\" },\n  ];\n  const order = stageStr.includes(\"Commit\") || stageStr.includes(\"Best Case\")\n    ? bestCaseCommitOrder\n    : pipelineOrder;\n\n  if (touchedSet && touchedSet.size > 0) {\n    const nextUntouched = order.find((s) => !touchedSet.has(s.touchedKey));\n    if (nextUntouched) return nextUntouched;\n  }\n  return order[0];\n}\n\nexport function buildPrompt(deal: Deal, repName: string, totalCount: number, isFirstDeal: boolean, touchedSet: Set<string>, scoreDefs: ScoreDef[]) {\n  const stage = deal.forecast_stage || \"Pipeline\";\n  const amountStr = new Intl.NumberFormat(\"en-US\", {\n    style: \"currency\",\n    currency: \"USD\",\n    maximumFractionDigits: 0,\n  }).format(Number(deal.amount || 0));\n  const closeDateStr = deal.close_date ? new Date(deal.close_date).toLocaleDateString() : \"TBD\";\n  const oppName = (deal.opportunity_name || \"\").trim();\n  const oppNamePart = oppName ? ` — ${oppName}` : \"\";\n\n  const callPickup =\n    `Hi ${repName}, this is Matthew from Sales Forecaster. ` +\n    `Today we are reviewing ${totalCount} deals. ` +\n    `Let's jump in starting with ${deal.account_name}${oppNamePart} ` +\n    `for ${amountStr} in CRM Forecast Stage ${stage} closing ${closeDateStr}.`;\n\n  const dealOpening =\n    `Let’s look at ${deal.account_name}${oppNamePart}, ` +\n    `${stage}, ${amountStr}, closing ${closeDateStr}.`;\n\n  const riskRecall = deal.risk_summary\n    ? `Existing Risk Summary: ${deal.risk_summary}`\n    : \"No prior risk summary recorded.\";\n\n  const firstGap = computeFirstGap(deal, stage, touchedSet);\n  const labelMap = buildLabelMap(scoreDefs);\n  const labelKeyMap: Record<string, string> = {\n    pain_score: \"pain\",\n    metrics_score: \"metrics\",\n    champion_score: \"champion\",\n    criteria_score: \"criteria\",\n    competition_score: \"competition\",\n    timing_score: \"timing\",\n    budget_score: \"budget\",\n    eb_score: \"economic_buyer\",\n    process_score: \"process\",\n    paper_score: \"paper\",\n  };\n  const scoreVal = Number(deal?.[firstGap.key] ?? 0);\n  const labelCategory = labelKeyMap[firstGap.key] || \"\";\n  const label = (labelCategory && labelMap[labelCategory]?.[scoreVal]) || \"Unknown\";\n\n  const gapQuestion = (() => {\n    if (scoreVal >= 3) {\n      return `Last review ${firstGap.name} was strong. Has anything changed that could introduce new risk?`;\n    }\n    if (scoreVal === 0) {\n      if (String(stage).includes(\"Pipeline\")) {\n        if (firstGap.name === \"Pain\")\n          return \"What specific business problem is the customer trying to solve, and what happens if they do nothing?\";\n        if (firstGap.name === \"Metrics\")\n          return \"What measurable outcome has the customer agreed matters, and who validated it?\";\n        if (firstGap.name === \"Internal Sponsor\")\n          return \"Who is driving this internally, what is their role, and how have they shown advocacy?\";\n        if (firstGap.name === \"Budget\")\n          return \"Has budget been discussed or confirmed, and at what level?\";\n        return `What changed since last time on ${firstGap.name}?`;\n      }\n      return `What is the latest on ${firstGap.name}?`;\n    }\n    return `Last review ${firstGap.name} was ${label}. Have we made progress since the last review?`;\n  })();\n\n  const firstLine = isFirstDeal ? callPickup : dealOpening;\n  const criteriaBlock = formatScoreDefinitions(scoreDefs);\n\n  return `\nSYSTEM PROMPT — SALES FORECAST AGENT\nYou are a Sales Forecast Agent applying MEDDPICC + Timing + Budget to sales opportunities.\nYour job is to run fast, rigorous deal reviews that the rep can be honest in.\n\nNON-NEGOTIABLES\n- Speak only English. Do not switch languages.\n- Do NOT invent facts. Never assume answers that were not stated by the rep.\n- Do NOT reveal category scores, scoring logic, scoring matrix, or how a category is computed.\n- Do NOT speak coaching tips, category summaries, or \"what I heard.\" Coaching and summaries are allowed ONLY in the written fields that will be saved (e.g., *_summary, *_tip, risk_summary, next_steps).\n- Use concise spoken language. Keep momentum. No dead air after saves—always ask the next question.\n- Never use the word \"champion.\" Use \"internal sponsor\" or \"coach\" instead.\n\nHARD CONTEXT (NON-NEGOTIABLE)\nYou are reviewing exactly:\n- DEAL_ID: ${deal.id}\n- ACCOUNT_NAME: ${deal.account_name}\n- OPPORTUNITY_NAME: ${oppName || \"(none)\"}\n- STAGE: ${stage}\nNever change deal identity unless the rep explicitly corrects it.\n\nDEAL INTRO (spoken)\nAt the start of this deal, you may speak ONLY:\n1) \"${firstLine}\"\n2) \"${riskRecall}\"\nThen immediately ask the first category question: \"${gapQuestion}\"\n\nCATEGORY ORDER (strict)\nPipeline deals (strict order):\n1) Pain\n2) Metrics\n3) Internal Sponsor (do NOT say champion)\n4) Competition\n5) Budget\n\nBest Case / Commit deals (strict order):\n1) Pain\n2) Metrics\n3) Internal Sponsor\n4) Criteria\n5) Competition\n6) Timing\n7) Budget\n8) Economic Buyer\n9) Decision Process\n10) Paper Process\n\nRules:\n- Never skip ahead.\n- Never reorder.\n- Never revisit a category unless the rep introduces NEW information for that category.\n\nQUESTIONING RULES (spoken)\n- Exactly ONE primary question per category.\n- At most ONE clarification question if the answer is vague or incomplete.\n- No spoken summaries. No spoken coaching. No repeating the rep's answer back.\n- After capturing enough info, proceed: silently update fields and save, then immediately ask the next category question.\n\nSCORING / WRITTEN OUTPUT RULES (silent)\nFor each category you touch:\n- Update the category score (integer) consistent with your scoring definitions.\n- Update label/summary/tip ONLY in the dedicated fields for that category (e.g., pain_summary, pain_tip, etc.).\n- If no meaningful coaching tip is needed, leave the tip blank (do not invent filler).\n- Be skeptical by default. You are an auditor, not a cheerleader.\n- Only give a 3 when the rep provides concrete, current-cycle evidence that fully meets the definition.\n- If evidence is vague, aspirational, or second‑hand, score lower and explain the gap in the summary/tip.\n- Favor truth over momentum: it is better to downgrade than to accept weak proof.\n- MEDDPICC rigor is mandatory: a named person ≠ a Champion, and a stated metric ≠ validated Metrics.\n- Champion (Internal Sponsor) requires: power/influence, active advocacy, and a concrete action they drove in this cycle.\n- Metrics require: measurable outcome, baseline + target, and buyer validation (not just rep belief).\n\nSCORING CRITERIA (AUTHORITATIVE)\nUse these exact definitions as the litmus test for labels and scores:\n${criteriaBlock}\n\nIMPORTANT:\nThe criteria are ONLY for scoring. Do NOT ask extra questions beyond the ONE allowed clarification.\n\nUnknowns:\n- If the rep explicitly says it's unknown or not applicable, score accordingly (typically 0/Unknown) and write a short summary reflecting that.\n\nCATEGORY CHECK PATTERNS (spoken)\n- For categories with prior score >= 3:\n  Say: \"Last review <Category> was strong. Has anything changed that could introduce new risk?\"\n  If rep says \"NO\" or \"nothing changed\": say \"Got it.\" and move to next category WITHOUT saving.\n  If rep provides ANY other answer: ask ONE follow-up if needed, then SAVE with updated score/summary/tip (upgrade or downgrade based on evidence).\n\n- For categories with prior score 1 or 2:\n  MUST ASK THIS WAY: \"Last review <Category> was <Label>. Have we made progress since the last review?\"\n  If clear improvement: capture evidence, rescore upward, silently update label/summary/coaching tip, save.\n  If degradation (worse): capture evidence, rescore downward, silently update label/summary/coaching tip, save.\n  If unclear/vague: ask ONE challenging follow-up (accuracy > speed).\n  If no change / unchanged / no / no progress / etc.: confirm, then move on WITHOUT saving.\n  CRITICAL: Preserve existing summaries/tips when no change is reported. Do NOT overwrite good detail with empty or less detailed content.\n\n- For categories with prior score 0 (or empty):\n  Treat as \"not previously established.\"\n  Do NOT say \"last review was…\" or reference any prior state.\n  Ask the primary question directly.\n  ALWAYS SAVE after the rep answers.\n\nDEGRADATION (silent)\nAny category may drop (including 3 → 0) if evidence supports it. No score protection. Truth > momentum.\nIf degradation happens: capture the new risk, rescore downward, silently update summary/tip, save.\n\nCROSS-CATEGORY ANSWERS\nIf the rep provides info that answers a future category while answering the current one:\n- Silently extract it and store it for that future category.\n- When you reach that category later, do NOT re-ask; say only:\n  \"I already captured that earlier based on your previous answer.\"\nThen proceed to the next category.\n\nMANDATORY WORKFLOW (NON-NEGOTIABLE)\nAfter each rep answer:\n1) Say: \"Got it.\" (brief acknowledgment)\n2) If a save is required, call save_deal_data silently with score/summary/tip.\n3) Then immediately ask the next category question.\nNo spoken summaries or coaching.\n\nCRITICAL RULES:\n- Tool calls are 100% silent - never mention saving or updating\n- Follow the category check patterns exactly for when to save vs move on\n- If the rep says \"I don't know\" or provides weak evidence, still save with a low score (0-1)\n\nHEALTH SCORE (spoken only at end)\n- Health Score is ALWAYS out of 30 and is COMPUTED BY THE SYSTEM from category scores.\n- You must NEVER invent or guess the number. A system message will give you the exact score to say when it is time for the end-of-deal wrap; use that number exactly.\n- Never change the denominator. Never reveal individual category scores.\n- If asked how it was calculated: \"Your score is based on the completeness and strength of your MEDDPICC answers.\"\n\nEND-OF-DEAL WRAP (spoken + save — BOTH steps required)\nAfter all required categories for the deal type are reviewed:\n1. Synthesize an Updated Risk Summary and Suggested Next Steps based on everything discussed.\n2. Speak the wrap in this exact order:\n   a) \"Updated Risk Summary: <your synthesized risk summary>\"\n   b) Say: \"Your Deal Health Score is X out of 30.\" (X will be provided in a system message — use it exactly; do not make up a number)\n   c) \"Suggested Next Steps: <your recommended next steps>\"\n3. IMMEDIATELY call save_deal_data with NON-EMPTY text for BOTH:\n   - risk_summary: the exact risk summary you just spoke (required; saves the END summary)\n   - next_steps: the exact next steps you just spoke (required; saves the END next steps)\n   Do NOT include any score fields in this save. Do NOT call advance_deal until you have called save_deal_data with both risk_summary and next_steps.\n4. THEN call advance_deal tool silently.\n\nDo NOT ask for rep confirmation. Do NOT invite edits.\n`.trim();\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 385, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/maron/Documents/forecast-agent-api/web/lib/tools.ts"],"sourcesContent":["export function buildTools() {\n  const scoreInt = { type: \"integer\", minimum: 0, maximum: 3 };\n  return [\n    {\n      type: \"function\",\n      name: \"save_deal_data\",\n      description:\n        \"REQUIRED after EVERY rep answer. Save the score (0-3), summary, and coaching tip for the category you just asked about.\",\n      parameters: {\n        type: \"object\",\n        properties: {\n          pain_score: scoreInt,\n          pain_summary: { type: \"string\" },\n          pain_tip: { type: \"string\" },\n          metrics_score: scoreInt,\n          metrics_summary: { type: \"string\" },\n          metrics_tip: { type: \"string\" },\n          champion_score: scoreInt,\n          champion_summary: { type: \"string\" },\n          champion_tip: { type: \"string\" },\n          champion_name: { type: \"string\" },\n          champion_title: { type: \"string\" },\n          eb_score: scoreInt,\n          eb_summary: { type: \"string\" },\n          eb_tip: { type: \"string\" },\n          eb_name: { type: \"string\" },\n          eb_title: { type: \"string\" },\n          criteria_score: scoreInt,\n          criteria_summary: { type: \"string\" },\n          criteria_tip: { type: \"string\" },\n          process_score: scoreInt,\n          process_summary: { type: \"string\" },\n          process_tip: { type: \"string\" },\n          competition_score: scoreInt,\n          competition_summary: { type: \"string\" },\n          competition_tip: { type: \"string\" },\n          paper_score: scoreInt,\n          paper_summary: { type: \"string\" },\n          paper_tip: { type: \"string\" },\n          timing_score: scoreInt,\n          timing_summary: { type: \"string\" },\n          timing_tip: { type: \"string\" },\n          budget_score: scoreInt,\n          budget_summary: { type: \"string\" },\n          budget_tip: { type: \"string\" },\n          risk_summary: { type: \"string\" },\n          next_steps: { type: \"string\" },\n          rep_comments: { type: \"string\" },\n        },\n        required: [],\n      },\n      // Keep non-strict to match current behavior (optional fields).\n      strict: false,\n    },\n    {\n      type: \"function\",\n      name: \"advance_deal\",\n      description: \"Advance to the next deal after end-of-deal wrap.\",\n      parameters: { type: \"object\", properties: {} },\n      strict: false,\n    },\n  ];\n}\n\n"],"names":[],"mappings":";;;;AAAO,SAAS;IACd,MAAM,WAAW;QAAE,MAAM;QAAW,SAAS;QAAG,SAAS;IAAE;IAC3D,OAAO;QACL;YACE,MAAM;YACN,MAAM;YACN,aACE;YACF,YAAY;gBACV,MAAM;gBACN,YAAY;oBACV,YAAY;oBACZ,cAAc;wBAAE,MAAM;oBAAS;oBAC/B,UAAU;wBAAE,MAAM;oBAAS;oBAC3B,eAAe;oBACf,iBAAiB;wBAAE,MAAM;oBAAS;oBAClC,aAAa;wBAAE,MAAM;oBAAS;oBAC9B,gBAAgB;oBAChB,kBAAkB;wBAAE,MAAM;oBAAS;oBACnC,cAAc;wBAAE,MAAM;oBAAS;oBAC/B,eAAe;wBAAE,MAAM;oBAAS;oBAChC,gBAAgB;wBAAE,MAAM;oBAAS;oBACjC,UAAU;oBACV,YAAY;wBAAE,MAAM;oBAAS;oBAC7B,QAAQ;wBAAE,MAAM;oBAAS;oBACzB,SAAS;wBAAE,MAAM;oBAAS;oBAC1B,UAAU;wBAAE,MAAM;oBAAS;oBAC3B,gBAAgB;oBAChB,kBAAkB;wBAAE,MAAM;oBAAS;oBACnC,cAAc;wBAAE,MAAM;oBAAS;oBAC/B,eAAe;oBACf,iBAAiB;wBAAE,MAAM;oBAAS;oBAClC,aAAa;wBAAE,MAAM;oBAAS;oBAC9B,mBAAmB;oBACnB,qBAAqB;wBAAE,MAAM;oBAAS;oBACtC,iBAAiB;wBAAE,MAAM;oBAAS;oBAClC,aAAa;oBACb,eAAe;wBAAE,MAAM;oBAAS;oBAChC,WAAW;wBAAE,MAAM;oBAAS;oBAC5B,cAAc;oBACd,gBAAgB;wBAAE,MAAM;oBAAS;oBACjC,YAAY;wBAAE,MAAM;oBAAS;oBAC7B,cAAc;oBACd,gBAAgB;wBAAE,MAAM;oBAAS;oBACjC,YAAY;wBAAE,MAAM;oBAAS;oBAC7B,cAAc;wBAAE,MAAM;oBAAS;oBAC/B,YAAY;wBAAE,MAAM;oBAAS;oBAC7B,cAAc;wBAAE,MAAM;oBAAS;gBACjC;gBACA,UAAU,EAAE;YACd;YACA,+DAA+D;YAC/D,QAAQ;QACV;QACA;YACE,MAAM;YACN,MAAM;YACN,aAAa;YACb,YAAY;gBAAE,MAAM;gBAAU,YAAY,CAAC;YAAE;YAC7C,QAAQ;QACV;KACD;AACH"}},
    {"offset": {"line": 516, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/maron/Documents/forecast-agent-api/web/app/api/agent/sessions.ts"],"sourcesContent":["// Shared sessions storage - persists across hot reloads\n// Using a global variable to avoid Next.js module reload issues\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var __sessions__: Map<\n    string,\n    {\n      orgId: number;\n      repName: string;\n      deals: any[];\n      index: number;\n      scoreDefs: any[];\n      touched: Set<string>;\n      // Running Responses API item list (messages + tool calls + tool outputs).\n      items: any[];\n      // End-of-deal wrap must be saved for current deal before advancing.\n      wrapSaved: boolean;\n    }\n  > | undefined;\n}\n\n// Use existing global or create new Map\nconst sessions =\n  global.__sessions__ ||\n  (global.__sessions__ = new Map<\n    string,\n    {\n      orgId: number;\n      repName: string;\n      deals: any[];\n      index: number;\n      scoreDefs: any[];\n      touched: Set<string>;\n      items: any[];\n      wrapSaved: boolean;\n    }\n  >());\n\nexport { sessions };\n"],"names":[],"mappings":"AAAA,wDAAwD;AACxD,gEAAgE;;;;;AAqBhE,wCAAwC;AACxC,MAAM,WACJ,OAAO,YAAY,IACnB,CAAC,OAAO,YAAY,GAAG,IAAI,KAYxB"}},
    {"offset": {"line": 531, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/maron/Documents/forecast-agent-api/web/app/api/agent/init/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { Pool } from \"pg\";\nimport { randomUUID } from \"crypto\";\nimport { buildPrompt } from \"../../../../lib/prompt\";\nimport { buildTools } from \"../../../../lib/tools\";\n\nexport const runtime = \"nodejs\";\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: { rejectUnauthorized: false },\n});\n\nimport { sessions } from \"../sessions\";\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const orgId = Number(body.orgId || 1);\n    const repName = String(body.repName || \"Rep\");\n\n    const result = await pool.query(\n      `\n      SELECT o.*\n      FROM opportunities o\n      WHERE o.org_id = $1\n        AND o.rep_name = $2\n        AND o.review_now = TRUE\n        AND o.forecast_stage NOT IN ('Closed Won', 'Closed Lost')\n      ORDER BY o.id ASC\n      `,\n      [orgId, repName]\n    );\n    const defsRes = await pool.query(\n      `\n      SELECT category, score, label, criteria\n      FROM score_definitions\n      WHERE org_id = $1\n      ORDER BY category ASC, score ASC\n      `,\n      [orgId]\n    );\n\n    const deals = result.rows || [];\n    const scoreDefs = defsRes.rows || [];\n    const sessionId = randomUUID();\n    const touched = new Set<string>();\n    sessions.set(sessionId, { orgId, repName, deals, index: 0, scoreDefs, touched, items: [], wrapSaved: false });\n\n    const deal = deals[0];\n    const instructions = deal\n      ? buildPrompt(deal, repName.split(\" \")[0] || repName, deals.length, true, touched, scoreDefs)\n      : [\n          \"SYSTEM PROMPT — SALES FORECAST AGENT\",\n          \"You are Matthew from Sales Forecaster. Speak only English.\",\n          \"We are doing a structured forecast review.\",\n          \"No deals were found for this rep. Do NOT chat generally.\",\n          \"Ask the rep to provide a deal to review with:\",\n          \"- account name\",\n          \"- opportunity name (optional)\",\n          \"- forecast stage\",\n          \"- amount\",\n          \"- close date\",\n          \"Then ask the first MEDDPICC gap question for the provided stage.\",\n        ].join(\"\\n\");\n\n    return NextResponse.json({\n      sessionId,\n      instructions,\n      tools: buildTools(),\n    });\n  } catch (e: any) {\n    const fallbackInstructions = [\n      \"SYSTEM PROMPT — SALES FORECAST AGENT\",\n      \"You are Matthew from Sales Forecaster. Speak only English.\",\n      \"We are doing a structured forecast review.\",\n      \"I couldn't load deals from the system.\",\n      \"Ask the rep to provide a deal to review with:\",\n      \"- account name\",\n      \"- opportunity name (optional)\",\n      \"- forecast stage\",\n      \"- amount\",\n      \"- close date\",\n      \"Then ask the first MEDDPICC gap question for the provided stage.\",\n    ].join(\"\\n\");\n    const sessionId = randomUUID();\n    sessions.set(sessionId, { orgId: 1, repName: \"Rep\", deals: [], index: 0, scoreDefs: [], touched: new Set<string>(), items: [], wrapSaved: false });\n    return NextResponse.json({\n      sessionId,\n      instructions: fallbackInstructions,\n      tools: buildTools(),\n      error: \"Init failed\",\n      detail: e?.message || String(e),\n    });\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AASA;;;;;;;;;;AAPO,MAAM,UAAU;AAEvB,MAAM,OAAO,IAAI,qJAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK;QAAE,oBAAoB;IAAM;AACnC;;AAIO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,QAAQ,OAAO,KAAK,KAAK,IAAI;QACnC,MAAM,UAAU,OAAO,KAAK,OAAO,IAAI;QAEvC,MAAM,SAAS,MAAM,KAAK,KAAK,CAC7B,CAAC;;;;;;;;MAQD,CAAC,EACD;YAAC;YAAO;SAAQ;QAElB,MAAM,UAAU,MAAM,KAAK,KAAK,CAC9B,CAAC;;;;;MAKD,CAAC,EACD;YAAC;SAAM;QAGT,MAAM,QAAQ,OAAO,IAAI,IAAI,EAAE;QAC/B,MAAM,YAAY,QAAQ,IAAI,IAAI,EAAE;QACpC,MAAM,YAAY,IAAA,mHAAU;QAC5B,MAAM,UAAU,IAAI;QACpB,oJAAQ,CAAC,GAAG,CAAC,WAAW;YAAE;YAAO;YAAS;YAAO,OAAO;YAAG;YAAW;YAAS,OAAO,EAAE;YAAE,WAAW;QAAM;QAE3G,MAAM,OAAO,KAAK,CAAC,EAAE;QACrB,MAAM,eAAe,OACjB,IAAA,qIAAW,EAAC,MAAM,QAAQ,KAAK,CAAC,IAAI,CAAC,EAAE,IAAI,SAAS,MAAM,MAAM,EAAE,MAAM,SAAS,aACjF;YACE;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD,CAAC,IAAI,CAAC;QAEX,OAAO,uJAAY,CAAC,IAAI,CAAC;YACvB;YACA;YACA,OAAO,IAAA,mIAAU;QACnB;IACF,EAAE,OAAO,GAAQ;QACf,MAAM,uBAAuB;YAC3B;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;YACA;SACD,CAAC,IAAI,CAAC;QACP,MAAM,YAAY,IAAA,mHAAU;QAC5B,oJAAQ,CAAC,GAAG,CAAC,WAAW;YAAE,OAAO;YAAG,SAAS;YAAO,OAAO,EAAE;YAAE,OAAO;YAAG,WAAW,EAAE;YAAE,SAAS,IAAI;YAAe,OAAO,EAAE;YAAE,WAAW;QAAM;QAChJ,OAAO,uJAAY,CAAC,IAAI,CAAC;YACvB;YACA,cAAc;YACd,OAAO,IAAA,mIAAU;YACjB,OAAO;YACP,QAAQ,GAAG,WAAW,OAAO;QAC/B;IACF;AACF"}}]
}