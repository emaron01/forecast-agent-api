{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/maron/Documents/forecast-agent-api/web/app/api/stt/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\n\nexport const runtime = \"nodejs\";\n\nfunction resolveBaseUrl() {\n  const raw = (process.env.OPENAI_BASE_URL || process.env.MODEL_API_URL || \"\").trim();\n  if (!raw) return \"\";\n  // Allow re-using old Realtime URLs (wss://.../v1/realtime) by converting them.\n  const wsNormalized = raw.replace(/^wss:\\/\\//i, \"https://\").replace(/^ws:\\/\\//i, \"http://\");\n  const strippedRealtime = wsNormalized.replace(/\\/v1\\/realtime(?:\\/calls)?$/i, \"/v1\");\n  const noTrail = strippedRealtime.replace(/\\/+$/, \"\");\n  // Accept either https://api.openai.com or https://api.openai.com/v1\n  return noTrail.endsWith(\"/v1\") ? noTrail : `${noTrail}/v1`;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const baseUrl = resolveBaseUrl();\n    const apiKey = process.env.MODEL_API_KEY || process.env.OPENAI_API_KEY;\n    const model = process.env.TRANSCRIBE_MODEL;\n\n    if (!baseUrl)\n      return NextResponse.json(\n        { ok: false, error: \"Missing OPENAI_BASE_URL (or MODEL_API_URL)\" },\n        { status: 500 }\n      );\n    if (!apiKey) return NextResponse.json({ ok: false, error: \"Missing MODEL_API_KEY\" }, { status: 500 });\n    if (!model) return NextResponse.json({ ok: false, error: \"Missing TRANSCRIBE_MODEL\" }, { status: 500 });\n\n    const form = await req.formData();\n    const file = form.get(\"file\");\n    if (!(file instanceof File)) {\n      return NextResponse.json({ ok: false, error: \"Missing audio file (field: file)\" }, { status: 400 });\n    }\n\n    const outForm = new FormData();\n    outForm.set(\"model\", model);\n    // Preserve filename/type for OpenAI ingestion\n    outForm.set(\"file\", file, file.name || \"audio.webm\");\n    const language = form.get(\"language\");\n    if (typeof language === \"string\" && language.trim()) outForm.set(\"language\", language.trim());\n\n    const resp = await fetch(`${baseUrl}/audio/transcriptions`, {\n      method: \"POST\",\n      headers: { Authorization: `Bearer ${apiKey}` },\n      body: outForm,\n    });\n\n    const text = await resp.text();\n    if (!resp.ok) {\n      return NextResponse.json({ ok: false, error: text || \"Transcription failed\" }, { status: resp.status });\n    }\n\n    let json: any = null;\n    try {\n      json = JSON.parse(text);\n    } catch {\n      return NextResponse.json({ ok: false, error: \"Transcription returned non-JSON\", raw: text }, { status: 502 });\n    }\n\n    return NextResponse.json({ ok: true, text: String(json?.text || \"\") });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || String(e) }, { status: 500 });\n  }\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,UAAU;AAEvB,SAAS;IACP,MAAM,MAAM,CAAC,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,aAAa,IAAI,EAAE,EAAE,IAAI;IACjF,IAAI,CAAC,KAAK,OAAO;IACjB,+EAA+E;IAC/E,MAAM,eAAe,IAAI,OAAO,CAAC,cAAc,YAAY,OAAO,CAAC,aAAa;IAChF,MAAM,mBAAmB,aAAa,OAAO,CAAC,gCAAgC;IAC9E,MAAM,UAAU,iBAAiB,OAAO,CAAC,QAAQ;IACjD,oEAAoE;IACpE,OAAO,QAAQ,QAAQ,CAAC,SAAS,UAAU,GAAG,QAAQ,GAAG,CAAC;AAC5D;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,UAAU;QAChB,MAAM,SAAS,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,cAAc;QACtE,MAAM,QAAQ,QAAQ,GAAG,CAAC,gBAAgB;QAE1C,IAAI,CAAC,SACH,OAAO,uJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO;QAA6C,GACjE;YAAE,QAAQ;QAAI;QAElB,IAAI,CAAC,QAAQ,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;QACnG,IAAI,CAAC,OAAO,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;QAErG,MAAM,OAAO,MAAM,IAAI,QAAQ;QAC/B,MAAM,OAAO,KAAK,GAAG,CAAC;QACtB,IAAI,CAAC,CAAC,gBAAgB,IAAI,GAAG;YAC3B,OAAO,uJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO;YAAmC,GAAG;gBAAE,QAAQ;YAAI;QACnG;QAEA,MAAM,UAAU,IAAI;QACpB,QAAQ,GAAG,CAAC,SAAS;QACrB,8CAA8C;QAC9C,QAAQ,GAAG,CAAC,QAAQ,MAAM,KAAK,IAAI,IAAI;QACvC,MAAM,WAAW,KAAK,GAAG,CAAC;QAC1B,IAAI,OAAO,aAAa,YAAY,SAAS,IAAI,IAAI,QAAQ,GAAG,CAAC,YAAY,SAAS,IAAI;QAE1F,MAAM,OAAO,MAAM,MAAM,GAAG,QAAQ,qBAAqB,CAAC,EAAE;YAC1D,QAAQ;YACR,SAAS;gBAAE,eAAe,CAAC,OAAO,EAAE,QAAQ;YAAC;YAC7C,MAAM;QACR;QAEA,MAAM,OAAO,MAAM,KAAK,IAAI;QAC5B,IAAI,CAAC,KAAK,EAAE,EAAE;YACZ,OAAO,uJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO,QAAQ;YAAuB,GAAG;gBAAE,QAAQ,KAAK,MAAM;YAAC;QACvG;QAEA,IAAI,OAAY;QAChB,IAAI;YACF,OAAO,KAAK,KAAK,CAAC;QACpB,EAAE,OAAM;YACN,OAAO,uJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO;gBAAmC,KAAK;YAAK,GAAG;gBAAE,QAAQ;YAAI;QAC7G;QAEA,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM,MAAM,OAAO,MAAM,QAAQ;QAAI;IACtE,EAAE,OAAO,GAAQ;QACf,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW,OAAO;QAAG,GAAG;YAAE,QAAQ;QAAI;IACxF;AACF"}}]
}