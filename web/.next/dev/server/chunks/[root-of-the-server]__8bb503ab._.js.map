{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/maron/Documents/forecast-agent-api/web/app/api/tts/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\n\nexport const runtime = \"nodejs\";\n\nfunction resolveBaseUrl() {\n  const raw = (process.env.OPENAI_BASE_URL || process.env.MODEL_API_URL || \"\").trim();\n  if (!raw) return \"\";\n  // Allow re-using old Realtime URLs (wss://.../v1/realtime) by converting them.\n  const wsNormalized = raw.replace(/^wss:\\/\\//i, \"https://\").replace(/^ws:\\/\\//i, \"http://\");\n  const strippedRealtime = wsNormalized.replace(/\\/v1\\/realtime(?:\\/calls)?$/i, \"/v1\");\n  const noTrail = strippedRealtime.replace(/\\/+$/, \"\");\n  // Accept either https://api.openai.com or https://api.openai.com/v1\n  return noTrail.endsWith(\"/v1\") ? noTrail : `${noTrail}/v1`;\n}\n\nfunction toBase64(buf: ArrayBuffer) {\n  // Node.js Buffer is available in Next nodejs runtime\n  return Buffer.from(buf).toString(\"base64\");\n}\n\nexport async function POST(req: Request) {\n  try {\n    const baseUrl = resolveBaseUrl();\n    const apiKey = process.env.MODEL_API_KEY || process.env.OPENAI_API_KEY;\n    const model = process.env.TTS_MODEL;\n    const voice = process.env.TTS_VOICE;\n    const responseFormat = process.env.TTS_FORMAT || \"mp3\";\n\n    if (!baseUrl)\n      return NextResponse.json(\n        { ok: false, error: \"Missing OPENAI_BASE_URL (or MODEL_API_URL)\" },\n        { status: 500 }\n      );\n    if (!apiKey) return NextResponse.json({ ok: false, error: \"Missing MODEL_API_KEY\" }, { status: 500 });\n    if (!model) return NextResponse.json({ ok: false, error: \"Missing TTS_MODEL\" }, { status: 500 });\n    if (!voice) return NextResponse.json({ ok: false, error: \"Missing TTS_VOICE\" }, { status: 500 });\n\n    const body = await req.json().catch(() => ({}));\n    const input = String(body?.text || \"\").trim();\n    if (!input) return NextResponse.json({ ok: false, error: \"Missing text\" }, { status: 400 });\n\n    const resp = await fetch(`${baseUrl}/audio/speech`, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${apiKey}`,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        model,\n        voice,\n        input,\n        response_format: responseFormat,\n      }),\n    });\n\n    if (!resp.ok) {\n      const errText = await resp.text();\n      return NextResponse.json({ ok: false, error: errText || \"TTS failed\" }, { status: resp.status });\n    }\n\n    const buf = await resp.arrayBuffer();\n    const b64 = toBase64(buf);\n    // For now, return base64 for browser playback.\n    return NextResponse.json({\n      ok: true,\n      audio_base64: b64,\n      mime: responseFormat === \"wav\" ? \"audio/wav\" : responseFormat === \"aac\" ? \"audio/aac\" : responseFormat === \"opus\" ? \"audio/opus\" : \"audio/mpeg\",\n    });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || String(e) }, { status: 500 });\n  }\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,UAAU;AAEvB,SAAS;IACP,MAAM,MAAM,CAAC,QAAQ,GAAG,CAAC,eAAe,IAAI,QAAQ,GAAG,CAAC,aAAa,IAAI,EAAE,EAAE,IAAI;IACjF,IAAI,CAAC,KAAK,OAAO;IACjB,+EAA+E;IAC/E,MAAM,eAAe,IAAI,OAAO,CAAC,cAAc,YAAY,OAAO,CAAC,aAAa;IAChF,MAAM,mBAAmB,aAAa,OAAO,CAAC,gCAAgC;IAC9E,MAAM,UAAU,iBAAiB,OAAO,CAAC,QAAQ;IACjD,oEAAoE;IACpE,OAAO,QAAQ,QAAQ,CAAC,SAAS,UAAU,GAAG,QAAQ,GAAG,CAAC;AAC5D;AAEA,SAAS,SAAS,GAAgB;IAChC,qDAAqD;IACrD,OAAO,OAAO,IAAI,CAAC,KAAK,QAAQ,CAAC;AACnC;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,UAAU;QAChB,MAAM,SAAS,QAAQ,GAAG,CAAC,aAAa,IAAI,QAAQ,GAAG,CAAC,cAAc;QACtE,MAAM,QAAQ,QAAQ,GAAG,CAAC,SAAS;QACnC,MAAM,QAAQ,QAAQ,GAAG,CAAC,SAAS;QACnC,MAAM,iBAAiB,QAAQ,GAAG,CAAC,UAAU,IAAI;QAEjD,IAAI,CAAC,SACH,OAAO,uJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO;QAA6C,GACjE;YAAE,QAAQ;QAAI;QAElB,IAAI,CAAC,QAAQ,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;QACnG,IAAI,CAAC,OAAO,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;QAC9F,IAAI,CAAC,OAAO,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAoB,GAAG;YAAE,QAAQ;QAAI;QAE9F,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC7C,MAAM,QAAQ,OAAO,MAAM,QAAQ,IAAI,IAAI;QAC3C,IAAI,CAAC,OAAO,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAEzF,MAAM,OAAO,MAAM,MAAM,GAAG,QAAQ,aAAa,CAAC,EAAE;YAClD,QAAQ;YACR,SAAS;gBACP,eAAe,CAAC,OAAO,EAAE,QAAQ;gBACjC,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;gBACnB;gBACA;gBACA;gBACA,iBAAiB;YACnB;QACF;QAEA,IAAI,CAAC,KAAK,EAAE,EAAE;YACZ,MAAM,UAAU,MAAM,KAAK,IAAI;YAC/B,OAAO,uJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO,WAAW;YAAa,GAAG;gBAAE,QAAQ,KAAK,MAAM;YAAC;QAChG;QAEA,MAAM,MAAM,MAAM,KAAK,WAAW;QAClC,MAAM,MAAM,SAAS;QACrB,+CAA+C;QAC/C,OAAO,uJAAY,CAAC,IAAI,CAAC;YACvB,IAAI;YACJ,cAAc;YACd,MAAM,mBAAmB,QAAQ,cAAc,mBAAmB,QAAQ,cAAc,mBAAmB,SAAS,eAAe;QACrI;IACF,EAAE,OAAO,GAAQ;QACf,OAAO,uJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW,OAAO;QAAG,GAAG;YAAE,QAAQ;QAAI;IACxF;AACF"}}]
}